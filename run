#!/usr/bin/env bash
# Krilin Security Framework v1.0
# Author: 0xb0rn3 (0xbv1)
# Mail: q4n0@proton.me | X & Discord: 0xbv1 | IG: theehiv3

set -e

R='\033[1;31m'
G='\033[1;32m'
Y='\033[1;33m'
B='\033[1;34m'
C='\033[1;36m'
M='\033[1;35m'
W='\033[1;37m'
N='\033[0m'

LOG="/var/log/krilin.log"
FAILED="/tmp/krilin_failed.txt"

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG"; }
info() { echo -e "${C}[*]${N} $1"; }
success() { echo -e "${G}[+]${N} $1"; }
warn() { echo -e "${Y}[!]${N} $1"; }
error() { echo -e "${R}[✗]${N} $1"; }

check_root() {
    [ "$(id -u)" -ne 0 ] && { error "Root access required. Run with sudo."; exit 1; }
}

is_docker() {
    [ -f /.dockerenv ] && return 0
    grep -q docker /proc/1/cgroup 2>/dev/null && return 0
    return 1
}

detect_system() {
    info "System detection..."
    
    if ! grep -qE "Debian|Ubuntu" /etc/os-release; then
        error "Debian-based system required"
        exit 1
    fi
    
    if is_docker; then
        warn "Docker environment detected"
        export IS_DOCKER=true
    else
        IS_DOCKER=false
        local space=$(df -m / | awk 'NR==2 {print $4}')
        if [ "$space" -lt 10000 ]; then
            warn "Low disk space: ${space}MB (recommend 10GB+)"
            read -p "Continue? (y/n): " -n 1 -r; echo
            [[ ! $REPLY =~ ^[Yy]$ ]] && exit 0
        fi
    fi
    
    success "OS: $(grep PRETTY_NAME /etc/os-release | cut -d'"' -f2)"
    success "Kernel: $(uname -r)"
    success "Arch: $(uname -m)"
}

fix_package_system() {
    info "Fixing package system..."
    rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock /var/lib/dpkg/lock*
    killall -9 apt-get dpkg 2>/dev/null || true
    dpkg --configure -a 2>/dev/null || true
    apt-get install -f -y -qq 2>/dev/null || true
    apt-get clean
    apt-get update -qq 2>/dev/null || warn "Package update had issues"
    success "Package system ready"
}

install_deps() {
    info "Installing dependencies..."
    local deps=(bc curl wget git gnupg gnupg2 dirmngr apt-transport-https ca-certificates lsb-release software-properties-common python3 python3-pip)
    
    apt-get update -qq 2>/dev/null || true
    for dep in "${deps[@]}"; do
        dpkg -l | grep -q "^ii  $dep" || apt-get install -y -qq "$dep" 2>/dev/null || warn "Failed: $dep"
    done
    success "Dependencies ready"
}

block_rpcbind() {
    info "Blocking rpcbind..."
    if dpkg -l | grep -q "^ii  rpcbind"; then
        systemctl stop rpcbind rpcbind.socket 2>/dev/null || true
        apt-get remove --purge -y rpcbind 2>/dev/null || true
    fi
    
    cat > /etc/apt/preferences.d/krilin-block << EOF
Package: rpcbind
Pin: release *
Pin-Priority: -1

Package: nfs-common
Pin: release *
Pin-Priority: -1
EOF
    success "rpcbind blocked"
}

add_kali() {
    info "Adding Kali repository..."
    local urls=(
        "https://archive.kali.org/kali/pool/main/k/kali-archive-keyring/kali-archive-keyring_2025.1_all.deb"
        "https://http.kali.org/kali/pool/main/k/kali-archive-keyring/kali-archive-keyring_2024.3_all.deb"
    )
    
    for url in "${urls[@]}"; do
        if wget -q -O /tmp/kali-key.deb "$url" 2>/dev/null; then
            dpkg -i /tmp/kali-key.deb 2>/dev/null && break
        fi
    done
    
    echo "deb http://http.kali.org/kali kali-rolling main contrib non-free non-free-firmware" > /etc/apt/sources.list.d/krilin-kali.list
    apt-get update -qq 2>/dev/null || true
    success "Kali repository ready"
}

add_parrot() {
    info "Adding Parrot repository..."
    local urls=(
        "https://deb.parrot.sh/parrot/pool/main/p/parrot-archive-keyring/parrot-archive-keyring_2024.12_all.deb"
        "https://deb.parrotsec.org/parrot/pool/main/p/parrot-archive-keyring/parrot-archive-keyring_2024.12_all.deb"
    )
    
    for url in "${urls[@]}"; do
        if wget -q -O /tmp/parrot-key.deb "$url" 2>/dev/null; then
            dpkg -i /tmp/parrot-key.deb 2>/dev/null && break
        fi
    done
    
    echo "deb https://deb.parrot.sh/parrot/ parrot main contrib non-free non-free-firmware" > /etc/apt/sources.list.d/krilin-parrot.list
    apt-get update -qq 2>/dev/null || true
    success "Parrot repository ready"
}

cleanup_repos() {
    info "Removing temporary repositories..."
    rm -f /etc/apt/sources.list.d/krilin-kali.list /etc/apt/sources.list.d/krilin-parrot.list
    apt-get update -qq 2>/dev/null || true
    success "Repositories cleaned"
}

install_pkg() {
    local pkg="$1"
    local attempts=3
    
    for i in $(seq 1 $attempts); do
        dpkg -l | grep -q "^ii  $pkg" && return 0
        if apt-get install -y -qq --no-install-recommends "$pkg" 2>/dev/null; then
            success "Installed: $pkg"
            return 0
        fi
        [ $i -lt $attempts ] && sleep 2 && dpkg --configure -a 2>/dev/null || true
    done
    
    error "Failed: $pkg"
    echo "$pkg" >> "$FAILED"
    return 1
}

install_list() {
    local -n pkgs=$1
    local ok=0 fail=0
    
    for pkg in "${pkgs[@]}"; do
        if install_pkg "$pkg"; then ((ok++)); else ((fail++)); fi
    done
    
    info "Results: $ok installed, $fail failed"
}

banner() {
    clear
    cat << "EOF"
╔══════════════════════════════════════════════════════════╗
║                                                          ║
║   ██╗  ██╗██████╗ ██╗██╗     ██╗███╗   ██╗              ║
║   ██║ ██╔╝██╔══██╗██║██║     ██║████╗  ██║              ║
║   █████╔╝ ██████╔╝██║██║     ██║██╔██╗ ██║              ║
║   ██╔═██╗ ██╔══██╗██║██║     ██║██║╚██╗██║              ║
║   ██║  ██╗██║  ██║██║███████╗██║██║ ╚████║              ║
║   ╚═╝  ╚═╝╚═╝  ╚═╝╚═╝╚══════╝╚═╝╚═╝  ╚═══╝              ║
║                                                          ║
║   Security Framework v1.0                                ║
║   Kali Linux & Parrot Security OS Support                ║
║                                                          ║
║   By: 0xb0rn3 (0xbv1)                                    ║
║   Mail: q4n0@proton.me | X & Discord: 0xbv1              ║
║   Instagram: theehiv3                                    ║
║                                                          ║
╚══════════════════════════════════════════════════════════╝
EOF
}

main_menu() {
    echo -e "\n${C}Main Menu:${N}\n"
    echo -e "${G}[1]${N} Kali Linux Tools"
    echo -e "${G}[2]${N} Parrot Security OS"
    echo -e "${G}[3]${N} Custom Install"
    echo -e "${G}[0]${N} Exit"
    echo
}

kali_menu() {
    echo -e "\n${C}Kali Linux Categories:${N}\n"
    echo -e "${G}[1]${N} Information Gathering"
    echo -e "${G}[2]${N} Vulnerability Analysis"
    echo -e "${G}[3]${N} Exploitation Tools"
    echo -e "${G}[4]${N} Wireless Attacks"
    echo -e "${G}[5]${N} Web Applications"
    echo -e "${G}[6]${N} Password Attacks"
    echo -e "${G}[7]${N} Full Kali ${Y}(10+ GB)${N}"
    echo -e "${G}[0]${N} Back"
    echo
}

parrot_menu() {
    echo -e "\n${C}Parrot Security Editions:${N}\n"
    echo -e "${G}[1]${N} Core (Minimal)"
    echo -e "${G}[2]${N} Home (Desktop)"
    echo -e "${G}[3]${N} Security (Full Tools)"
    echo -e "${G}[0]${N} Back"
    echo
}

install_kali() {
    local cat="$1"
    declare -a tools
    
    case "$cat" in
        1) tools=(nmap dnsrecon theharvester recon-ng maltego) ;;
        2) tools=(nikto sqlmap lynis openvas wapiti) ;;
        3) tools=(metasploit-framework exploitdb set beef-xss) ;;
        4) tools=(aircrack-ng reaver wifite kismet) ;;
        5) tools=(burpsuite zaproxy wfuzz dirb gobuster) ;;
        6) tools=(hydra john hashcat crunch wordlists) ;;
        7) tools=(kali-linux-large) ;;
        *) error "Invalid category"; return 1 ;;
    esac
    
    block_rpcbind
    add_kali
    install_list tools
    cleanup_repos
}

install_parrot() {
    local ed="$1"
    declare -a pkgs
    
    block_rpcbind
    add_parrot
    
    case "$ed" in
        1) pkgs=(parrot-core) ;;
        2) pkgs=(parrot-core parrot-interface-home parrot-desktop-mate) ;;
        3) pkgs=(parrot-core parrot-interface-home parrot-desktop-mate parrot-tools-full) ;;
        *) error "Invalid edition"; cleanup_repos; return 1 ;;
    esac
    
    install_list pkgs
    cleanup_repos
}

custom_install() {
    info "Enter package list file path:"
    read -p "Path: " list_path
    
    [ ! -f "$list_path" ] && { error "File not found"; return; }
    
    echo "[1] Kali | [2] Parrot | [3] Debian"
    read -p "Repository: " repo
    
    case $repo in
        1) add_kali ;;
        2) add_parrot ;;
        3) ;;
        *) error "Invalid choice"; return ;;
    esac
    
    block_rpcbind
    
    local -a list
    mapfile -t list < "$list_path"
    install_list list
    cleanup_repos
}

kali_handler() {
    while true; do
        kali_menu
        read -p "Choice: " choice
        
        case $choice in
            [1-6]) install_kali "$choice" ;;
            7)
                warn "This will download 10+ GB"
                read -p "Continue? (y/n): " -n 1 -r; echo
                [[ $REPLY =~ ^[Yy]$ ]] && install_kali 7
                ;;
            0) return ;;
            *) error "Invalid choice" ;;
        esac
    done
}

parrot_handler() {
    while true; do
        parrot_menu
        read -p "Choice: " choice
        
        case $choice in
            [1-3]) install_parrot "$choice" ;;
            0) return ;;
            *) error "Invalid choice" ;;
        esac
    done
}

main() {
    check_root
    touch "$LOG" && > "$FAILED"
    log "Krilin started"
    
    banner
    detect_system
    fix_package_system
    install_deps
    
    while true; do
        main_menu
        read -p "Choice: " choice
        
        case $choice in
            1) kali_handler ;;
            2) parrot_handler ;;
            3) custom_install ;;
            0)
                cleanup_repos
                fix_package_system
                
                if [ -s "$FAILED" ]; then
                    warn "Failed packages:"
                    cat "$FAILED"
                    info "Saved to: $FAILED"
                fi
                
                success "Installation complete"
                log "Krilin completed"
                exit 0
                ;;
            *) error "Invalid choice" ;;
        esac
    done
}

trap 'warn "Interrupted"; cleanup_repos; exit 130' INT TERM
main "$@"
