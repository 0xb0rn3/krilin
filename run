#!/usr/bin/env bash
# Krilin Security Framework v0.3
# Author: 0xbv1(0xb0rn3) | q4n0@proton.me | X/Discord: oxbv1 | IG: theehiv3

set -e

C_RESET="\033[0m"
C_RED="\033[1;31m"
C_GREEN="\033[1;32m"
C_YELLOW="\033[1;33m"
C_BLUE="\033[1;34m"
C_CYAN="\033[1;36m"
C_MAGENTA="\033[1;35m"

log_info() { echo -e "${C_CYAN}[*]${C_RESET} $1"; }
log_ok() { echo -e "${C_GREEN}[+]${C_RESET} $1"; }
log_warn() { echo -e "${C_YELLOW}[!]${C_RESET} $1"; }
log_err() { echo -e "${C_RED}[-]${C_RESET} $1"; }

check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        log_err "Root access required. Run with sudo"
        exit 1
    fi
}

is_docker() {
    [ -f /.dockerenv ] || grep -q docker /proc/1/cgroup 2>/dev/null
}

print_banner() {
    clear
    echo -e "${C_BLUE}â•"â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
    echo -e "${C_BLUE}â•'${C_CYAN}  â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—${C_RED}â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— ${C_YELLOW}â–ˆâ–ˆâ•—${C_GREEN}â–ˆâ–ˆâ•—     ${C_BLUE}â–ˆâ–ˆâ•—${C_MAGENTA}â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—${C_BLUE}  â•'${C_RESET}"
    echo -e "${C_BLUE}â•'${C_CYAN}  â–ˆâ–ˆâ•'  â–ˆâ–ˆâ•'${C_RED}â–ˆâ–ˆâ•"â•â•â•â•â• ${C_YELLOW}â–ˆâ–ˆâ•'${C_GREEN}â–ˆâ–ˆâ•'     ${C_BLUE}â–ˆâ–ˆâ•'${C_MAGENTA}â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•'${C_BLUE}  â•'${C_RESET}"
    echo -e "${C_BLUE}â•'${C_CYAN}  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•'${C_RED}â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—${C_YELLOW}â–ˆâ–ˆâ•'${C_GREEN}â–ˆâ–ˆâ•'     ${C_BLUE}â–ˆâ–ˆâ•'${C_MAGENTA}â–ˆâ–ˆâ•"â–ˆâ–ˆâ•— â–ˆâ–ˆâ•'${C_BLUE}  â•'${C_RESET}"
    echo -e "${C_BLUE}â•'${C_CYAN}  â–ˆâ–ˆâ•"â•â•â•â–ˆâ–ˆâ•'${C_RED}â–ˆâ–ˆâ•"â•â•â•â•â• ${C_YELLOW}â–ˆâ–ˆâ•'${C_GREEN}â–ˆâ–ˆâ•'     ${C_BLUE}â–ˆâ–ˆâ•'${C_MAGENTA}â–ˆâ–ˆâ•'â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•'${C_BLUE}  â•'${C_RESET}"
    echo -e "${C_BLUE}â•'${C_CYAN}  â–ˆâ–ˆâ•'  â–ˆâ–ˆâ•'${C_RED}â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—${C_YELLOW}â–ˆâ–ˆâ•'${C_GREEN}â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—${C_BLUE}â–ˆâ–ˆâ•'${C_MAGENTA}â–ˆâ–ˆâ•' â•šâ–ˆâ–ˆâ–ˆâ•'${C_BLUE}  â•'${C_RESET}"
    echo -e "${C_BLUE}â•'${C_GREEN}  Security Framework v0.3${C_BLUE}                     â•'${C_RESET}"
    echo -e "${C_BLUE}â•'${C_MAGENTA}  0xbv1(0xb0rn3) | IG: theehiv3${C_BLUE}             â•'${C_RESET}"
    echo -e "${C_BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
    
    if is_docker; then
        echo -e "${C_YELLOW}[DOCKER MODE]${C_RESET}"
    fi
    echo
}

detect_system() {
    log_info "System reconnaissance..."
    
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        echo -e "${C_GREEN}  OS:${C_RESET} $PRETTY_NAME"
    fi
    
    echo -e "${C_GREEN}  Kernel:${C_RESET} $(uname -r)"
    echo -e "${C_GREEN}  Arch:${C_RESET} $(uname -m)"
    
    if ! grep -qi "debian" /etc/os-release 2>/dev/null; then
        log_warn "Non-Debian system detected"
        read -p "Continue anyway? (y/n): " -n 1 -r
        echo
        [[ ! $REPLY =~ ^[Yy]$ ]] && exit 1
    fi
    
    if ! is_docker; then
        local free_gb=$(df -BG / | awk 'NR==2 {print $4}' | sed 's/G//')
        if [ "$free_gb" -lt 15 ]; then
            log_warn "Low disk space: ${free_gb}GB available"
        fi
    fi
    echo
}

install_deps() {
    log_info "Installing dependencies..."
    
    local critical_deps="bc curl wget git gnupg ca-certificates apt-transport-https python3 python3-pip"
    
    apt-get update -qq 2>/dev/null || {
        apt-get clean
        rm -rf /var/lib/apt/lists/*
        apt-get update -qq
    }
    
    for dep in $critical_deps; do
        if ! dpkg -l | grep -q "^ii  $dep "; then
            apt-get install -y -qq "$dep" 2>/dev/null || true
        fi
    done
    
    log_ok "Dependencies ready"
}

check_git_updates() {
    if [ ! -d ".git" ]; then
        return 0
    fi
    
    git fetch origin main --quiet 2>/dev/null || return 0
    
    local LOCAL=$(git rev-parse HEAD 2>/dev/null)
    local REMOTE=$(git rev-parse origin/main 2>/dev/null)
    
    if [ "$LOCAL" != "$REMOTE" ]; then
        log_info "Updates available"
        if git pull origin main --no-edit --quiet 2>/dev/null; then
            log_ok "Updated successfully"
        fi
    fi
}

main() {
    check_root
    print_banner
    detect_system
    install_deps
    check_git_updates
    
    if [ ! -f "core.py" ]; then
        log_err "core.py not found"
        exit 1
    fi
    
    chmod +x core.py
    
    echo -e "${C_BLUE}â•"â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${C_RESET}"
    echo -e "${C_BLUE}â•'${C_CYAN}          LAUNCHING KRILIN CORE${C_BLUE}           â•'${C_RESET}"
    echo -e "${C_BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${C_RESET}"
    echo
    
    python3 core.py "$@"
    
    echo
    log_ok "Session complete"
}

trap 'echo -e "\n${C_YELLOW}[!]${C_RESET} Interrupted"; exit 130' INT TERM

main "$@"
