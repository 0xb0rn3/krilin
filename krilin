#!/usr/bin/env python3
import os
import subprocess
import sys
import platform
import random
import time
import re

# Color and style codes for dramatic vibe
RED = '\033[91m'
GREEN = '\033[92m'
YELLOW = '\033[93m'
BLUE = '\033[94m'
MAGENTA = '\033[95m'
CYAN = '\033[96m'
BOLD = '\033[1m'
UNDERLINE = '\033[4m'
BLINK = '\033[5m'
NORMAL = '\033[0m'

# Kali repository URL
KALI_REPO = "deb http://http.kali.org/kali kali-rolling main contrib non-free"

# Categories including tools and kernels
CATEGORIES = {
    "1": ("Information Gathering", ["nmap", "dnsrecon", "theharvester", "maltego", "recon-ng"], False, "kali"),
    "2": ("Vulnerability Analysis", ["nikto", "sqlmap", "openvas-scanner", "legion", "lynis"], False, "kali"),
    "3": ("Exploitation Tools", ["metasploit-framework", "exploitdb", "beef-xss", "set", "backdoor-factory"], False, "kali"),
    "4": ("Wireless Attacks", ["aircrack-ng", "reaver", "wifite", "kismet", "bully"], False, "kali"),
    "5": ("Web Application Analysis", ["burpsuite", "zaproxy", "wfuzz", "dirb", "sqlmap"], False, "kali"),
    "6": ("Password Attacks", ["hydra", "john", "hashcat", "crunch", "wordlists"], False, "kali"),
    "7": ("All Kali Linux Tools", ["kali-linux-default"], False, "kali"),  # Metapackage for all default tools
    "8": ("Debian Backports Kernel", ["linux-image-amd64"], True, "backports"),
    "9": ("Kali Linux Kernel", ["linux-image-amd64"], True, "kali")
}

def dramatic_print(text, color=GREEN, delay=0.01):
    """Print text with dramatic effect."""
    for char in text:
        print(f"{color}{char}{NORMAL}", end='', flush=True)
        time.sleep(delay)
    print()

def display_banner():
    """Display a dramatic ASCII art banner."""
    banner = f"""
{CYAN}{BOLD}██╗  ██╗{RED}██████╗ {YELLOW}██╗{GREEN}██╗     {BLUE}██╗{MAGENTA}███╗   ██╗{NORMAL}
{CYAN}{BOLD}██║ ██╔╝{RED}██╔══██╗{YELLOW}██║{GREEN}██║     {BLUE}██║{MAGENTA}████╗  ██║{NORMAL}
{CYAN}{BOLD}█████╔╝ {RED}██████╔╝{YELLOW}██║{GREEN}██║     {BLUE}██║{MAGENTA}██╔██╗ ██║{NORMAL}
{CYAN}{BOLD}██╔═██╗ {RED}██╔══██╗{YELLOW}██║{GREEN}██║     {BLUE}██║{MAGENTA}██║╚██╗██║{NORMAL}
{CYAN}{BOLD}██║  ██╗{RED}██║  ██║{YELLOW}██║{GREEN}███████╗{BLUE}██║{MAGENTA}██║ ╚████║{NORMAL}
{CYAN}{BOLD}╚═╝  ╚═╝{RED}╚═╝  ╚═╝{YELLOW}╚═╝{GREEN}╚══════╝{BLUE}╚═╝{MAGENTA}╚═╝  ╚═══╝{NORMAL}
                                                 
{BLUE}{BOLD}╔═════════════════════════════════════════════╗{NORMAL}
{BLUE}{BOLD}║{GREEN} Weaponizing Debian with Kali Arsenal v0.2 {BLUE}      ║{NORMAL}
{BLUE}{BOLD}║{YELLOW} Developed by 0xb0rn3 (github.com/0xb0rn3) {BLUE}║{NORMAL}
{BLUE}{BOLD}╚═════════════════════════════════════════════╝{NORMAL}
"""
    print(banner)

def detect_system():
    """Detect and display system information."""
    # Get system information
    os_name = platform.system()
    os_release = platform.release()
    os_version = platform.version()
    machine_arch = platform.machine()
    
    # Get kernel information
    kernel_info = subprocess.check_output("uname -r", shell=True).decode().strip()
    
    # Get CPU information
    cpu_info = "Unknown"
    if os.path.exists("/proc/cpuinfo"):
        with open("/proc/cpuinfo", "r") as f:
            for line in f:
                if "model name" in line:
                    cpu_info = line.split(":")[1].strip()
                    break
    
    # Get RAM information
    ram_info = "Unknown"
    if os.path.exists("/proc/meminfo"):
        with open("/proc/meminfo", "r") as f:
            for line in f:
                if "MemTotal" in line:
                    ram_info = line.split(":")[1].strip()
                    break
    
    # Format and display system information
    print(f"\n{BOLD}{BLUE}[*] System Detection Results:{NORMAL}")
    print(f"{BOLD}{GREEN}[+] OS:{NORMAL} {os_name} {os_release}")
    print(f"{BOLD}{GREEN}[+] OS Version:{NORMAL} {os_version}")
    print(f"{BOLD}{GREEN}[+] Architecture:{NORMAL} {machine_arch}")
    print(f"{BOLD}{GREEN}[+] Kernel:{NORMAL} {kernel_info}")
    print(f"{BOLD}{GREEN}[+] CPU:{NORMAL} {cpu_info}")
    print(f"{BOLD}{GREEN}[+] Memory:{NORMAL} {ram_info}")
    
    # Check if it's a Debian-based system
    is_debian = False
    if os.path.exists("/etc/debian_version"):
        with open("/etc/debian_version", "r") as f:
            debian_version = f.read().strip()
            print(f"{BOLD}{GREEN}[+] Debian Version:{NORMAL} {debian_version}")
            is_debian = True
    
    if not is_debian:
        print(f"{BOLD}{RED}[!] Warning: This script is designed for Debian-based systems.{NORMAL}")
        answer = input(f"{BOLD}{YELLOW}[?] Continue anyway? (y/n):{NORMAL} ").lower()
        if answer != 'y':
            sys.exit(1)

def check_root():
    """Ensure the script runs with root privileges."""
    if os.geteuid() != 0:
        print(f"{RED}{BOLD}[!] This script must be run as root. Use 'sudo'.{NORMAL}")
        sys.exit(1)

def get_debian_codename():
    """Retrieve Debian codename from /etc/os-release."""
    with open("/etc/os-release", "r") as f:
        for line in f:
            if line.startswith("VERSION_CODENAME="):
                return line.split("=")[1].strip().strip('"')
    print(f"{RED}{BOLD}[!] Could not determine Debian codename.{NORMAL}")
    sys.exit(1)

def add_kali_keyring():
    """Download and install the Kali archive keyring package."""
    keyring_url = "https://http.kali.org/pool/main/k/kali-archive-keyring/kali-archive-keyring_2024.1_all.deb"
    keyring_file = "/tmp/kali-archive-keyring.deb"
    
    print(f"{CYAN}{BOLD}[*] Downloading and installing Kali archive keyring...{NORMAL}")
    
    try:
        # Download the keyring package
        subprocess.run(["wget", "-q", "-O", keyring_file, keyring_url], check=True)
        
        # Install the keyring package
        subprocess.run(["dpkg", "-i", keyring_file], check=True)
        
        # Clean up
        if os.path.exists(keyring_file):
            os.remove(keyring_file)
            
        print(f"{GREEN}{BOLD}[+] Kali archive keyring installed successfully.{NORMAL}")
        return True
        
    except subprocess.CalledProcessError as e:
        print(f"{RED}{BOLD}[!] Error installing Kali keyring: {e}{NORMAL}")
        print(f"{YELLOW}[!] Continuing without official Kali keyring. This may cause trust issues.{NORMAL}")
        return False

def add_repo(repo_type):
    """Add a temporary repository based on type."""
    print(f"{CYAN}{BOLD}[*] Adding {repo_type} repository...{NORMAL}")
    
    if repo_type == "kali":
        # Add Kali Linux GPG key via the keyring package
        add_kali_keyring()
        
        # Add repository
        with open("/etc/apt/sources.list.d/kali.list", "w") as f:
            f.write(f"{KALI_REPO}\n")
            
    elif repo_type == "backports":
        codename = get_debian_codename()
        with open("/etc/apt/sources.list.d/backports.list", "w") as f:
            f.write(f"deb http://deb.debian.org/debian {codename}-backports main\n")
    
    # Update apt cache
    print(f"{CYAN}{BOLD}[*] Updating package lists...{NORMAL}")
    try:
        subprocess.run(["apt-get", "update"], check=True)
        print(f"{GREEN}{BOLD}[+] Repository added and package list updated.{NORMAL}")
    except subprocess.CalledProcessError:
        print(f"{RED}{BOLD}[!] Failed to update package lists. Continuing anyway...{NORMAL}")

def check_for_rpcbind():
    """Check if rpcbind is installed."""
    try:
        # Use dpkg-query to check if rpcbind is installed
        result = subprocess.run(
            ["dpkg-query", "-W", "-f='${Status}'", "rpcbind"], 
            stdout=subprocess.PIPE, 
            stderr=subprocess.PIPE,
            universal_newlines=True,
            check=False
        )
        return "install ok installed" in result.stdout
    except Exception:
        return False

def remove_rpcbind():
    """Remove the rpcbind package and stop its service."""
    print(f"{CYAN}{BOLD}[*] Checking for rpcbind service...{NORMAL}")
    
    if check_for_rpcbind():
        print(f"{YELLOW}{BOLD}[!] rpcbind detected - this opens unnecessary network ports.{NORMAL}")
        print(f"{CYAN}{BOLD}[*] Stopping rpcbind service...{NORMAL}")
        
        # Stop the service first
        try:
            subprocess.run(["systemctl", "stop", "rpcbind"], check=False)
            subprocess.run(["systemctl", "disable", "rpcbind"], check=False)
        except Exception as e:
            print(f"{YELLOW}{BOLD}[!] Warning when stopping rpcbind service: {e}{NORMAL}")
        
        # Remove the package
        print(f"{CYAN}{BOLD}[*] Removing rpcbind package...{NORMAL}")
        try:
            subprocess.run(["apt-get", "remove", "-y", "rpcbind"], check=True)
            print(f"{GREEN}{BOLD}[+] rpcbind removed successfully.{NORMAL}")
        except subprocess.CalledProcessError as e:
            print(f"{RED}{BOLD}[!] Error removing rpcbind: {e}{NORMAL}")
    else:
        print(f"{GREEN}{BOLD}[+] rpcbind not installed - your system is more secure.{NORMAL}")

def remove_repo(repo_type):
    """Remove the temporary repository."""
    print(f"{CYAN}{BOLD}[*] Cleaning up {repo_type} repository...{NORMAL}")
    
    # First check and remove rpcbind if it was installed
    remove_rpcbind()
    
    # Then remove the repository files
    if repo_type == "kali" and os.path.exists("/etc/apt/sources.list.d/kali.list"):
        os.remove("/etc/apt/sources.list.d/kali.list")
    elif repo_type == "backports" and os.path.exists("/etc/apt/sources.list.d/backports.list"):
        os.remove("/etc/apt/sources.list.d/backports.list")
    
    # Update apt cache
    try:
        subprocess.run(["apt-get", "update"], check=True)
        print(f"{GREEN}{BOLD}[+] Repository removed and package list updated.{NORMAL}")
    except subprocess.CalledProcessError:
        print(f"{YELLOW}{BOLD}[!] Warning: Cleanup incomplete. You may need to manually fix your repositories.{NORMAL}")

def install_tools_or_kernel(category, packages, is_kernel, repo_type):
    """Install selected tools or kernel with dramatic flair."""
    weapons = ["arsenal", "weaponry", "armaments", "firepower", "ordnance"]
    power_words = ["unleashing", "deploying", "activating", "arming", "initializing"]
    
    chosen_weapon = random.choice(weapons)
    power_word = random.choice(power_words)
    
    dramatic_print(f"\n{BOLD}{RED}[*] {power_word.upper()} {category} {chosen_weapon}...{NORMAL}", RED, 0.02)
    
    try:
        add_repo(repo_type)
        
        # Remove rpcbind first to prevent dependency issues
        remove_rpcbind()
        
        # Show installation progress
        print(f"{CYAN}{BOLD}[*] Installing packages: {', '.join(packages)}{NORMAL}")
        
        if repo_type == "backports":
            codename = get_debian_codename()
            cmd = ['apt', 'install', '-y', '-t', f"{codename}-backports"] + packages
        else:
            cmd = ['apt', 'install', '-y'] + packages
        
        # Run the installation
        subprocess.run(cmd, check=True)
        
        print(f"{GREEN}{BOLD}[+] Installation complete. Your system has been enhanced.{NORMAL}")
        if is_kernel:
            print(f"{YELLOW}{BOLD}[!] Please reboot to activate the new kernel.{NORMAL}")
    
    except subprocess.CalledProcessError as e:
        print(f"{RED}{BOLD}[!] Error: Installation failed - {e}{NORMAL}")
    
    finally:
        # Don't call remove_rpcbind() here again since we already did it above
        # Just remove the repo
        if repo_type == "kali" and os.path.exists("/etc/apt/sources.list.d/kali.list"):
            os.remove("/etc/apt/sources.list.d/kali.list")
        elif repo_type == "backports" and os.path.exists("/etc/apt/sources.list.d/backports.list"):
            os.remove("/etc/apt/sources.list.d/backports.list")
        
        # Update apt cache
        try:
            subprocess.run(["apt-get", "update"], check=True)
            print(f"{GREEN}{BOLD}[+] Repository removed and package list updated.{NORMAL}")
        except subprocess.CalledProcessError:
            print(f"{YELLOW}{BOLD}[!] Warning: Cleanup incomplete. You may need to manually fix your repositories.{NORMAL}")

def display_menu():
    """Display the menu with dramatic styling."""
    print(f"\n{BOLD}{BLUE}╔══════════════════════════════════╗{NORMAL}")
    print(f"{BOLD}{BLUE}║{YELLOW} KRILIN - TOOLS AND KERNEL ARSENAL {BLUE}║{NORMAL}")
    print(f"{BOLD}{BLUE}╚══════════════════════════════════╝{NORMAL}")
    
    print(f"\n{BOLD}{GREEN}[*] Choose your weapon:{NORMAL}")
    
    for key, (category, _, is_kernel, _) in CATEGORIES.items():
        if is_kernel and key == "9":
            print(f"{BOLD}{RED}[{key}] {category} {RED}(Warning: may cause instability on Debian){NORMAL}")
        else:
            print(f"{BOLD}{CYAN}[{key}] {category}{NORMAL}")
    
    print(f"{BOLD}{YELLOW}[0] Exit{NORMAL}")

def main():
    """Main function to run the Krilin tool."""
    check_root()
    display_banner()
    detect_system()
    
    while True:
        display_menu()
        choice = input(f"\n{BOLD}{GREEN}[?] Select an option (0-9):{NORMAL} ").strip()
        
        if choice == "0":
            dramatic_print(f"{BOLD}{BLUE}[*] Exiting Krilin. Stay safe.{NORMAL}", BLUE, 0.02)
            break
        elif choice in CATEGORIES:
            category, packages, is_kernel, repo_type = CATEGORIES[choice]
            install_tools_or_kernel(category, packages, is_kernel, repo_type)
        else:
            print(f"{RED}{BOLD}[!] Invalid option. Please try again.{NORMAL}")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print(f"\n{YELLOW}{BOLD}[!] Operation cancelled by user.{NORMAL}")
        sys.exit(0)
